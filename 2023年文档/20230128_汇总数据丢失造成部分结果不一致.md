## 汇总数据丢失造成部分结果不一致

#### 前情

最近负责的一个数据汇总模块，上线后，出现部分数据的结果与业务预期不一致。

#### 问题分析

年后复工的第一天就收到生产问题的邮件，多少有点儿坏心情。为尽快转变开年的氛围，花了些时间把问题背景和代码结构重新梳理了一下，然后着手尝试解决的方法。由于业务抽象足够抽象，前期开发的时候没有足够的时间精力理解业务背景和部分细节，部分计算逻辑直接复用了存量代码，以前偷懒走的捷径又还了回去。

问题概述如下：对原始数据按组汇总，每组数据的处理方式相同，其中部分数据的结果与预期不一致。

问题定位第一步：最开始排除了通用方法部分，理由是汇总结果中只有部分数据异常。

问题定位第二步：排除了通用方法部分，查看了数据入库部分，并比对每一列的值是否有异常，与业务提供的数据对比，发现异常数据位于第一列，便对第一列的数据的来源方法进行定位排查。

问题定位第三步：第一列是原始数据分组并按一定规则求和而得，规则复用存量逻辑，这一部分经过评审，出问题的概率较小，遂排查原始数据，并在测试环境复现数据导入与汇总的过程，发现异常数据与生产运行的一直，与业务的预期不一致，此操作复现了本次邮件问题。

问题定位第四步：将异常的组别的数据拿出来，逐个分析，发现异常偏差数与原始数据中的某一行一致，此处推理汇总漏掉了该行数据，不禁猜想，为什么仅有部分组的汇总结果受影响，而不是全量有偏差呢？于是返回第一步，对通用方法部分进行分析，发现汇总过程有筛选，而受影响的恰好是没有被过滤掉的数据，从而造成了通用方法部分有问题，而受影响的只是部分数据。

#### 总结

事后发现，问题就出在了第一步，而第一步的分析没能将问题定位出来，只能通过后续的分析、问题复现、推测不断地将问题锚定还原出来 。

